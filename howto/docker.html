
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Deploy with Docker Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="router.html" />
    
    
    <link rel="prev" href="ssr-code-splitting.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <a target="_blank" href="https://github.com/forrestjs/core">
            
                    
                    give us a star on GitHub!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <a target="_blank" href="https://www.npmjs.com/package/@forrestjs/core">
            
                    
                    install from NPM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../api/">
            
                <a href="../api/">
            
                    
                    API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../api/create-ssr-state.html">
            
                <a href="../api/create-ssr-state.html">
            
                    
                    createSSRState
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../api/create-ssr-context.html">
            
                <a href="../api/create-ssr-context.html">
            
                    
                    createSSRContext
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../api/create-ssr-render.html">
            
                <a href="../api/create-ssr-render.html">
            
                    
                    createSSRRender
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../api/create-ssr-router.html">
            
                <a href="../api/create-ssr-router.html">
            
                    
                    createSSRRouter
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../api/memcached.html">
            
                <a href="../api/memcached.html">
            
                    
                    Memcached
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Step By Step Tutorial</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="setup.html">
            
                <a href="setup.html">
            
                    
                    Prerequisites & Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="app.html">
            
                <a href="app.html">
            
                    
                    Universal App
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="app-redux.html">
            
                <a href="app-redux.html">
            
                    
                    React Redux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="app-reducers.html">
            
                <a href="app-reducers.html">
            
                    
                    Reducers & Initial State
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3" data-path="features.html">
            
                <a href="features.html">
            
                    
                    Think in Features
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.3.1" data-path="features-users.html">
            
                <a href="features-users.html">
            
                    
                    users feature
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3.2" data-path="features-splash.html">
            
                <a href="features-splash.html">
            
                    
                    splash-screen feature
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="ssr.html">
            
                <a href="ssr.html">
            
                    
                    Server Side Rendering
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="ssr-folders.html">
            
                <a href="ssr-folders.html">
            
                    
                    Folders structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="ssr-babel.html">
            
                <a href="ssr-babel.html">
            
                    
                    Babel setup (transpiler)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.3" data-path="ssr-npm-dependencies.html">
            
                <a href="ssr-npm-dependencies.html">
            
                    
                    NPM dependencies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.4" data-path="ssr-npm-scripts.html">
            
                <a href="ssr-npm-scripts.html">
            
                    
                    NPM scripts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.5" data-path="ssr-frontend.html">
            
                <a href="ssr-frontend.html">
            
                    
                    the frontend script
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.6" data-path="ssr-backend.html">
            
                <a href="ssr-backend.html">
            
                    
                    the backend script
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.7" data-path="ssr-kickoff.html">
            
                <a href="ssr-kickoff.html">
            
                    
                    the kickoff scripts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.8" data-path="ssr-code-splitting.html">
            
                <a href="ssr-code-splitting.html">
            
                    
                    code splitting
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="2.4" data-path="docker.html">
            
                <a href="docker.html">
            
                    
                    Deploy with Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="router.html">
            
                <a href="router.html">
            
                    
                    Add React Router
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.5.1" data-path="router-setup.html">
            
                <a href="router-setup.html">
            
                    
                    basic setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.2" data-path="router-routes.html">
            
                <a href="router-routes.html">
            
                    
                    add some routes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.3" data-path="router-load.html">
            
                <a href="router-load.html">
            
                    
                    load stuff
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="seo.html">
            
                <a href="seo.html">
            
                    
                    SEO Optimization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="eslint.html">
            
                <a href="eslint.html">
            
                    
                    Customize ESLint
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="graphql.html">
            
                <a href="graphql.html">
            
                    
                    Add GraphQL
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.8.1" data-path="graphql-setup.html">
            
                <a href="graphql-setup.html">
            
                    
                    setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.8.2" data-path="graphql-backend.html">
            
                <a href="graphql-backend.html">
            
                    
                    backend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.8.3" data-path="graphql-frontend.html">
            
                <a href="graphql-frontend.html">
            
                    
                    frontend
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="multilanguage.html">
            
                <a href="multilanguage.html">
            
                    
                    Add Multilanguage Support
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Articles</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../articles/reducers.html">
            
                <a href="../articles/reducers.html">
            
                    
                    Reducers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../articles/services.html">
            
                <a href="../articles/services.html">
            
                    
                    Services
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../articles/styled-components.html">
            
                <a href="../articles/styled-components.html">
            
                    
                    SSR with Styled Components
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Other Stuff</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../DEVELOPMENT.html">
            
                <a href="../DEVELOPMENT.html">
            
                    
                    Development
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Deploy with Docker</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="deploy-with-docker">Deploy with Docker</h1>
<p>It&apos;s always been a challenge to bring your app to production. Lukily for us
<a href="https://www.docker.com/" target="_blank">Docker</a> came and made things much much easier, taking
away all the server-level knowledge that was once needed.</p>
<p>In this tutorial we are going to package our universal app as a Docker image
that you can run, distribute on Docker Hub, and deploy on one of the many
serverless services available today.</p>
<blockquote>
<p><strong>NOTE:</strong> This tutorial assumes that you went through the <a href="setup.html">step by step tutorial</a>
and have a fully working app. You can always download the ready to use boilerplate
<a href="https://github.com/marcopeg/react-ssr/raw/master/examples/cra-ssr-universal.zip" target="_blank">here</a>.</p>
</blockquote>
<h3 id="dockerfile">Dockerfile</h3>
<p>A <a href="https://docs.docker.com/engine/reference/builder/" target="_blank">Dockerfile</a> is the receipt for
a new Docker image. You can write yours in <code>/Dockerfile</code>:</p>
<pre><code>#
# Build Production Artifacts
# ==========================================
#
# this first step takes in the source files and build the artifacts
# (basicall all that need to be transpiled).
#
# We do install the NPM dependencies twice so to copy over to the
# production image only what is strictly needed to execute our app.
# 
# NPM Install is the first step so to exploit Docker&apos;s cache mechanism
# and speed up the building process. We will re-install from NPM only
# if we touch the `package.json` file. Which doesn&apos;t happen so often.
#

FROM node:10.14-alpine AS builder

# NPM Install for building
WORKDIR /usr/src/app-build
ADD package.json /usr/src/app-build/package.json
RUN npm install

# NPM Install for production
WORKDIR /usr/src/app-run
ADD package.json /usr/src/app-run/package.json
RUN npm install --only=production

# Copy source files:
WORKDIR /usr/src/app-build
ADD index.js /usr/src/app-build
ADD .babelrc /usr/src/app-build
ADD webpack.config.extend.js /usr/src/app-build
ADD webpackDevServer.config.extend.js /usr/src/app-build

# Build backend
WORKDIR /usr/src/app-build
ADD ssr /usr/src/app-build/ssr
RUN npm run build:ssr

# Build frontend
WORKDIR /usr/src/app-build
ADD src /usr/src/app-build/src
RUN npm run build:src
ADD public /usr/src/app-build/public
RUN ./node_modules/.bin/react-scripts build




#
# Runner Image
# ==========================================
#
# in this step we start over with a fresh image and copy only what is
# strictly necessary in order to run a production build.
#
# the idea is to keep this image as small as possible.
#

FROM node:10.14-alpine AS runner

# Copy assets for build:
WORKDIR /usr/src/app
COPY --from=builder /usr/src/app-run/node_modules ./node_modules
COPY --from=builder /usr/src/app-build/build ./build
COPY --from=builder /usr/src/app-build/build-src ./build-src
COPY --from=builder /usr/src/app-build/build-ssr ./build-ssr
ADD package.json /usr/src/app
ADD index.js /usr/src/app

# Default environment configuration:
EXPOSE 8080
ENV NODE_ENV=production

CMD node index.js
</code></pre><p>Long story short this is the best I could come up with to achieve my 2 main goals:</p>
<ul>
<li>quick build</li>
<li>small image size</li>
</ul>
<p>You also want to edit the production entry point <code>index.js</code> and add:</p>
<pre><code>// Let Docker exit on Ctrl+C
process.on(&apos;SIGINT&apos;, function() {
    process.exit();
});
</code></pre><p>This will ensure that the container correctly exits when you <code>Ctrl+C</code>!</p>
<p>You can test this out by building this image:</p>
<pre><code>docker build -t cra-ssr .
</code></pre><p>And then by running it:</p>
<pre><code>docker run --rm -p 8080:8080 cra-ssr
</code></pre><p>If all goes as expected you should be able to open your app on:</p>
<pre><code>http://localhost:8080
</code></pre><blockquote>
<p><strong>NOTE:</strong> if <code>8080</code> is not available you can change it to pretty much any value:<br><code>docker run --rm -p 9876:8080 cra-ssr</code></p>
</blockquote>
<h3 id="makefile">Makefile</h3>
<p><a href="https://www.tutorialspoint.com/makefile/" target="_blank">make</a> come built into every linux desktop
distribution that I know. Let&apos;s use it!</p>
<p>You might be already familiar with Grunt or Gulp... well... Make exists practically since 
the beginning of time and does more or less the same stuff as Grunt or Gulp. But it does it
in your terminal so it is way more powerful.</p>
<p>In this section you are going to create a <code>/Makefile</code> with some simple tasks that will
make it easier to build and run your Docker project:</p>
<pre><code class="lang-sh"><span class="hljs-comment">#</span>
<span class="hljs-comment"># Simple interface to run Docker!</span>
<span class="hljs-comment">#</span>


<span class="hljs-comment"># Running container&apos;s name</span>
name?=cra-ssr

<span class="hljs-comment"># Docker image tag name</span>
tag?=<span class="hljs-variable">${name}</span>

<span class="hljs-comment"># Build the project using cache</span>
image:
    docker build -t <span class="hljs-variable">${tag}</span> .

<span class="hljs-comment"># Spins up a container from the latest available image</span>
<span class="hljs-comment"># this is useful to test locally</span>
run:
    docker run \
        --rm \
        --name <span class="hljs-variable">${name}</span> \
        -p 8080:8080 \
        <span class="hljs-variable">${name}</span>

stop:
    docker stop <span class="hljs-variable">${name}</span>

remove:
    docker rm <span class="hljs-variable">${name}</span>

<span class="hljs-comment"># Like start, but in background</span>
<span class="hljs-comment"># classic way to launch it on a server</span>
boot:
    docker run \
        <span class="hljs-_">-d</span> \
        --name <span class="hljs-variable">${name}</span> \
        -p 8080:8080 \
        <span class="hljs-variable">${name}</span>

down: stop remove

<span class="hljs-comment"># Gain access to a running container</span>
ssh:
    docker <span class="hljs-built_in">exec</span> \
        -it \
        <span class="hljs-variable">${name}</span> \
        /bin/sh
</code></pre>
<blockquote>
<p><strong>NOTE:</strong> you must substitute the indentation with <code>tabs</code> for Make to work
properly.</p>
</blockquote>
<p>To use this stuff simply open your terminal and try to type:</p>
<pre><code>make image
make boot
</code></pre><p>This will build your app and run it in background.</p>
<pre><code>make down
</code></pre><p>Will stop it and remove the container.</p>
<p>Do you want to run the app and access the Docker container to inspect some stuff?</p>
<pre><code>make boot
make ssh
</code></pre><p>(<code>Ctrl+c</code> to exit back to your terminal)</p>
<h3 id="docker-composeyaml">docker-compose.yaml</h3>
<p>The last option is <a href="https://docs.docker.com/compose/" target="_blank">docker-compose</a> which I believe to be
one of the greatest achievement of Mankind.</p>
<p>Create <code>/docker-compose.yaml</code>:</p>
<pre><code>version: &apos;2.1&apos;
services:
    app:
        build: .
        ports:
            - 8080:8080
</code></pre><p>Then just type this in your terminal:</p>
<pre><code>docker-compose up
</code></pre><p>You app will magically start.</p>
<h2 id="go-live-on-nowsh">Go live on Now.sh</h2>
<p><a href="https://zeit.co/now" target="_blank">now.sh</a> is a wonderful serverless platform that let you
run some small app for free in a varaiety of possible ways.</p>
<p>We take advantage of our Docker definition and make our app available to the entire
world in 3 simple steps:</p>
<h3 id="step-n1---create-an-account">Step n.1 - Create an account</h3>
<p><a href="https://zeit.co/now" target="_blank">Go to &quot;now.sh&quot;</a> and create your free account, you can quikly
login with your GitHub account.</p>
<p>At one point you will be prompted to download the Now app and CLI utility. We are
going to use it in step n.3!</p>
<h3 id="step-n2---create-a-deploy-manifest">Step n.2 - Create a deploy manifest</h3>
<p>Create <code>/now.json</code>:</p>
<pre><code>{
  &quot;version&quot;: 1,
  &quot;type&quot;: &quot;docker&quot;,
  &quot;features&quot;: {
    &quot;cloud&quot;: &quot;v2&quot;
  }
}
</code></pre><h3 id="step-n3---deploy">Step n.3 - Deploy!</h3>
<pre><code>now
</code></pre><p>Yes, it&apos;s that simple.</p>
<p>Take a close look at the console because you will be given your app&apos;s url.<br>Mine is: <a href="https://cra-ssr-ancovrmtzt.now.sh/" target="_blank">https://cra-ssr-ancovrmtzt.now.sh/</a>.</p>
<h2 id="tutorial-codebase">Tutorial Codebase</h2>
<p>As always, you can <a href="https://github.com/marcopeg/react-ssr/raw/master/examples/cra-ssr-docker.zip" target="_blank">download the boilerplate</a>.
where you will find all the files discussed in this page.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="ssr-code-splitting.html" class="navigation navigation-prev " aria-label="Previous page: code splitting">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="router.html" class="navigation navigation-next " aria-label="Next page: Add React Router">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Deploy with Docker","level":"2.4","depth":1,"next":{"title":"Add React Router","level":"2.5","depth":1,"path":"howto/router.md","ref":"./howto/router.md","articles":[{"title":"basic setup","level":"2.5.1","depth":2,"path":"howto/router-setup.md","ref":"./howto/router-setup.md","articles":[]},{"title":"add some routes","level":"2.5.2","depth":2,"path":"howto/router-routes.md","ref":"./howto/router-routes.md","articles":[]},{"title":"load stuff","level":"2.5.3","depth":2,"path":"howto/router-load.md","ref":"./howto/router-load.md","articles":[]}]},"previous":{"title":"code splitting","level":"2.3.8","depth":2,"path":"howto/ssr-code-splitting.md","ref":"./howto/ssr-code-splitting.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["code","collapsible-menu"],"pluginsConfig":{"code":{"copyButtons":true},"collapsible-menu":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"howto/docker.md","mtime":"2019-05-08T09:01:16.408Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-05-14T14:09:43.664Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

